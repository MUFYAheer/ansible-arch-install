---
- hosts: all
  tasks:
    - name: Install some basic packages to make the system useful
      pacman:
        name:
          - base-devel
          - bind-tools
          - curl
          - emacs
          - git
          - gnupg
          - screen
          - source-highlight
          - stow
      tags:
        - pacman
    - name: Install pyenv
      shell: curl https://pyenv.run | bash
      args:
        creates: /home/{{ ansible_user }}/.pyenv
      become_user: "{{ ansible_user }}"
      tags:
        - pyenv
    - name: Install .dotfiles
      block:
        - name: Checkout .dotfiles repository
          git:
            repo: git@github.com:jsf9k/.dotfiles.git
            dest: /home/{{ ansible_user }}/.dotfiles
            accept_hostkey: yes
        - name: Install dotfiles
          command: ./deploy.sh
          args:
            chdir: /home/{{ ansible_user }}/.dotfiles
            creates: /home/{{ ansible_user }}/.bashrc.d
      become_user: "{{ ansible_user }}"
      tags:
        - dotfiles
    - name: Ensure basic ufw service configuration
      block:
        - name: Install the ufw service
          pacman:
            name:
              - ufw
          tags:
            - pacman
        - name: Enable and start the ufw service
          systemd:
            name: ufw
            enabled: yes
            state: started
        - name: Allow incoming ssh traffic through the firewall
          ufw:
            rule: allow
            to_port: ssh
            proto: tcp
        - name: Enable firewall
          ufw:
            default: deny
            logging: 'on'
            state: enabled
      tags:
        - ufw
- hosts: basicx
  tasks:
    - name: Install packages for a basic machine with X
      pacman:
        name:
          - alsa-utils
          - chromium
          - feh
          - ratpoison
          - rxvt-unicode
          - rxvt-unicode-terminfo
          - ttf-inconsolata
          - xdm-archlinux
          - xlockmore
          - xorg-server
          - xterm
      tags:
        - pacman
    - name: Enable and start the xdm service
      systemd:
        name: xdm-archlinux
        enabled: yes
        state: started
      tags:
        - xdm
- hosts: cisa
  tasks:
    - name: Install dev packages
      pacman:
        name:
          - ansible
          - terraform
      tags:
        - pacman
    - name: Install CISA .dotfiles
      block:
        - name: Checkout .dotfiles_cisa repository
          git:
            repo: git@github.com:jsf9k/.dotfiles_cisa.git
            dest: /home/{{ ansible_user }}/.dotfiles_cisa
            accept_hostkey: yes
        - name: Install dotfiles
          command: ./deploy.sh
          args:
            chdir: /home/{{ ansible_user }}/.dotfiles_cisa
            creates: /home/{{ ansible_user }}/.emacs.d/identity.el
      become_user: "{{ ansible_user }}"
      tags:
        - dotfiles
- hosts: home
  tasks:
    - name: Install home .dotfiles
      block:
        - name: Checkout .dotfiles_home repository
          git:
            repo: git@github.com:jsf9k/.dotfiles_home.git
            dest: /home/{{ ansible_user }}/.dotfiles_home
            accept_hostkey: yes
        - name: Install dotfiles
          command: ./deploy.sh
          args:
            chdir: /home/{{ ansible_user }}/.dotfiles_home
            creates: /home/{{ ansible_user }}/.emacs.d/identity.el
      become_user: "{{ ansible_user }}"
      tags:
        - dotfiles
